<project name="pastry" default="compile" basedir="./">

  <!-- Necessary properties and paths -->
  <property name="src.dir" value="src"/>
  <property name="build.dir" value="classes" />  
  <property name="lib.dir" value="lib" />
  <property name="pretty.dir" value="pretty" />
  <property name="pretty.dir" value="pretty/lib" />
  <property name="docs.dir" value="docs" />
  <property name="javadoc.dir" value="${docs.dir}/javadoc" />

  <!-- Jars that Pretty package needs -->
  <path id="pretty.classpath">
    <fileset dir="${pretty.lib.dir}">
      <include name="**/*.jar"/>
    </fileset>
  </path>

  <!-- The classpath -->
  <path id="project.classpath">
    <fileset dir="${lib.dir}">
      <include name="**/*.jar"/>
    </fileset>
    <pathelement path="${build.dir}"/>
  </path>
  
  <!-- The source -->
  <path id="project.excluded.source">
    <fileset dir="${src.dir}">
      <!-- Excludes go here -->
      <include name="rice/ap3/**/*.java"/>
      <include name="rice/email/**/*.java"/>
      <include name="rice/fs/**/*.java"/>
      <include name="rice/im/**/*.java"/>
      <include name="rice/nls/**/*.java"/>
      <include name="rice/p2p/**/*.java"/>
      <include name="rice/pastry/**/*.java"/>
      <include name="rice/persistence/**/*.java"/>
      <include name="rice/post/**/*.java"/>
      <include name="rice/proxy/**/*.java"/>
      <include name="rice/rm/**/*.java"/>
      <include name="rice/storage/**/*.java"/>
      <include name="rice/testharness/**/*.java"/>
      <include name="rice/visualization/**/*.java"/>
      <include name="rice/watchdog/**/*.java"/>
    </fileset>
  </path>

  <!-- Source we need to build RMIC stubs for -->
  <path id="project.rmic.files">
    <fileset dir="${build.dir}">
      <include name="rice/pastry/rmi/RMIRemoteNodeI.class"/>
    </fileset>
  </path>

  <!-- TASKS BELOW -->

  <target name="clean">
    <delete dir="${build.dir}"/>
  </target>
  
  <!-- All the stuff that needs to be done before anything can happen -->
  <target name="init">
    <!-- make the directory to put all classes in -->
    <mkdir dir="${build.dir}"/>

    <!-- make a list of the excluded source -->
    <pathconvert refid="project.excluded.source"
                 pathsep=","
		 property="project.excluded.src.list"/>
  </target>

  <target name="make_rmic_stubs" depends="init">
    <rmic  base="${build.dir}"
           classpathref="project.classpath"
           includes="${rmic.includes.files}"/>
  </target>

  <target name="make_imap_parser" depends="init">
    <antlr target="${src.dir}/rice/email/proxy/imap/parser/antlr/lexer.g" />
    <antlr target="${src.dir}/rice/email/proxy/imap/parser/antlr/grammer.g" />
  </target>

  <!-- 	   excludes="${project.excluded.src.list}" -->

  <target name="compile" depends="init,make_imap_parser">
    <javac srcdir="${src.dir}"
           destdir="${build.dir}"
	   classpathref="project.classpath"
	   includes="**/*.java"
           deprecation="yes">

      <!-- Compilation problems :( -->
      <exclude name="rice/ap3/**/*.java"/>
      <exclude name="rice/fs/**/*.java"/>
      <exclude name="rice/im/**/*.java"/>

      <!-- Depends on rice.past (which was removed) -->
      <!-- Evaluate this package later -->
      <exclude name="rice/testharness/**/*.java"/>

      <!-- Projects waiting to be fixed -->

      <!-- 23 errors ... emailed Alan -->      
      <exclude name="rice/email/test/**/*.java"/>

      <!-- 14 errors.  Emailed Animesh -->
      <exclude name="rice/rm/**/*.java"/>

      <!-- Waiting on two bug fixes from Alan -->
      <exclude name="rice/post/**/*.java"/>

    </javac>
    <antcall target="make_rmic_stubs"/>
  </target>

  <target name="beautify" depends="init">
    <fail unless="pretty.src.dir" 
          message="You must set the pretty.src.dir property"/>
    <pathconvert refid="pretty.classpath"
                 pathsep=":"
		 property="pretty.classpath.path"/>
    <taskdef name="pretty" 
             classname="org.acm.seguin.ant.Pretty" 
	     classpath="${pretty.classpath.path}"/>
    <pretty settingsDir="${pretty.dir}" cvs="true">      
      <fileset dir="${src.dir}/${pretty.src.dir}" includes="**/*.java"/> 
    </pretty>  
  </target> 

  <target name="javadoc" depends="init">
    <javadoc destdir="${javadoc.dir}"
             classpathref="project.classpath"
             windowtitle="Rice Pastry - API Specifications"
             use="true">
       <fileset dir="${src.dir}"
                includes="**/*.java"
                excludes="${project.excluded.src.list}"/>
       <doctitle>Rice Pastry API</doctitle>
       <header>Rice Pastry API</header>
       <bottom><![CDATA[<i>Copyright &#169; 2001 - Rice Pastry.</i>]]></bottom>
    </javadoc>
  </target>

  <!-- Distribution-related targets -->
  <target name="jar" depends="compile">   
    <jar destfile="${build.dir}/pastry.jar">
      <fileset dir="${build.dir}" includes="**/*.class"/>
    </jar>
  </target>

</project>